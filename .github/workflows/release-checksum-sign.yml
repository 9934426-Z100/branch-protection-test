
name: Attach checksums and GPG signature to release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  checksum-and-sign:
    runs-on: ubuntu-latest
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE:  ${{ secrets.GPG_PASSPHRASE }}

    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq gnupg

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p assets
          gh api repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            --jq '.assets[].browser_download_url' > urls.txt
          if [ ! -s urls.txt ]; then
            echo "No assets on this release. Exiting."
            exit 0
          fi
          while read -r url; do
            curl -fsSL "$url" -o "assets/$(basename "$url")"
          done < urls.txt

      - name: Generate checksum.txt (sha256)
        run: |
          set -euo pipefail
          cd assets
          files=$(ls -1 | grep -v -E '(checksum|\.asc$|\.sig$)' || true)
          if [ -z "$files" ]; then
            echo "No target files to hash. Exiting."
            exit 0
          fi
          echo "$files" | xargs -d '\n' sha256sum > checksum.txt
          cat checksum.txt

      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes \
            --pinentry-mode loopback \
            --passphrase "$GPG_PASSPHRASE" --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Sign checksum.txt
        if: hashFiles('assets/checksum.txt') != ''
        run: |
          set -euo pipefail
          cd assets
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "$GPG_PASSPHRASE" \
              --armor --detach-sign checksum.txt

      - name: Upload checksum and signature
        if: hashFiles('assets/checksum.txt') != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            assets/checksum.txt assets/checksum.txt.asc --clobber
