
# このワークフローは、GitHub Release が公開（published）されたタイミングで起動します。
# 処理内容：
# 1) 該当リリースの全アセットをダウンロード
# 2) SHA-256 の checksum.txt を生成（checksum/署名関連のファイルは除外）
# 3) checksum.txt を GPG で署名（ASCII armored: checksum.txt.asc）
# 4) checksum.txt と checksum.txt.asc を同じリリースに追添付
# 利用者は公開鍵で checksum.txt.asc を検証 → checksum.txt で各ファイルの整合性確認が可能になります。

name: Attach checksums and GPG signature to release

on:
  release:
    types: [published]   # リリースが "公開" になった時のみ起動（draft保存や編集では動かない）

permissions:
  contents: write        # リリースへのアセット追加（gh release upload）が書込権限を必要とする

jobs:
  checksum-and-sign:
    runs-on: ubuntu-latest

    # 署名に必要な秘密鍵/パスフレーズを Job 全体の環境変数に渡す
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE:  ${{ secrets.GPG_PASSPHRASE }}

    steps:
      # gh CLI の一部操作（release upload）は .git の存在を前提にするため、必ず checkout します
      - name: Checkout repository
        uses: actions/checkout@v4

      # jq: gh api の JSON から URL を抽出するのに使用
      # gnupg: GPG 鍵の import と署名に使用
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gnupg

      # 対象リリース（トリガーになった release.id）のアセット一覧を API で取得し、ダウンロードします。
      # ここでは拡張子の限定は行わず、あとで checksum 対象から署名関連を除外します。
      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # gh CLI の認証（Actions が自動付与）
        run: |
          set -euo pipefail
          mkdir -p assets

          # リリースアセットのダウンロードURLを取得（1行1URL）
          gh api repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            --jq '.assets[].browser_download_url' > urls.txt

          # アセットが1つもない場合は処理不要（チェックサム/署名を生成する意味が無い）
          if [ ! -s urls.txt ]; then
            echo "No assets on this release. Exiting without error."
            exit 0
          fi

          # 実ファイルのダウンロード（assets/ 配下へ保存）
          while read -r url; do
            echo "Downloading: $url"
            curl -fsSL "$url" -o "assets/$(basename "$url")"
          done < urls.txt

      # SHA-256 の checksum.txt を生成します。
      # 署名ファイル（.asc / .sig）や既存の checksum ファイルは除外して衝突や自己参照を回避します。
      - name: Generate checksum.txt (sha256)
        run: |
          set -euo pipefail
          cd assets

          # 対象ファイル一覧を作成（除外フィルタ：checksum/署名関連を除く）
          files=$(ls -1 | grep -v -E '(checksum|\.asc$|\.sig$)' || true)

          # 対象が無い場合は終了（例えばリリースに署名関連しか無いケース）
          if [ -z "$files" ]; then
            echo "No target files to hash. Exiting without error."
            exit 0
          fi

          # Windows 相当のファイル名も含む可能性があるので xargs の区切りを厳格に（改行）
          # sha256sum の出力形式： "<hash> <2スペース> <ファイル名>"
          printf "%s\n" "$files" | xargs -d '\n' sha256sum > checksum.txt
          echo "Generated checksum.txt:"
          cat checksum.txt

      # Secrets に保存した "ASCII armored" の秘密鍵をインポートします。
      # CI では対話入力ができないため、--pinentry-mode loopback と --passphrase を明示します。
      - name: Import GPG key
        run: |
          set -euo pipefail
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes \
            --pinentry-mode loopback \
            --passphrase "$GPG_PASSPHRASE" \
            --import

          # 取り込み確認（鍵ID/指紋の可視化のみ。秘密鍵そのものは出力されません）
          gpg --list-secret-keys --keyid-format LONG

      # checksum.txt に対して ASCII 署名（detach-sign）を作成します。
      # 出力ファイル： checksum.txt.asc
      # if で存在チェックを入れ、アセット無し等で checksum が無い場合はスキップします。
      - name: Sign checksum.txt
        if: hashFiles('assets/checksum.txt') != ''   # checksum.txt が存在・非空なら署名する
        run: |
          set -euo pipefail
          cd assets
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "$GPG_PASSPHRASE" \
              --armor --detach-sign checksum.txt

      # 生成した checksum.txt / checksum.txt.asc を同じリリースへ追添付します。
      # --clobber により同名ファイルが存在する場合は上書きします（再実行や鍵更新に備える運用）。
      - name: Upload checksum and signature
        if: hashFiles('assets/checksum.txt') != ''   # checksum.txt が無い場合はスキップ（実行不要）
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release upload "${{ github.event.release.tag_name }}" \
            assets/checksum.txt \
            assets/checksum.txt.asc \
            --clobber

      # ここまで到達すれば正常終了
